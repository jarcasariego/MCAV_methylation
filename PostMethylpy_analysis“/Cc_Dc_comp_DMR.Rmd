---
title: "One-one_comparizon_DMR"
author: "Javier Rodriguez-Casariego"
date: "12/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

load libraries
```{r}
library(data.table)
library(gplots)
library(ggplot2) #install.packages('ggplot2')
library(dplyr)
library(broom)
library(RColorBrewer)
library(egg) #install.packages('egg')
library(purrr)
library(nlme)
library(vegan)
```

```{r}
allsamples_DMR <- fread('DMR_files/-1.2alignment/alltreat_DMR250bp_cov5x_rms_results_collapsed.tsv', sep = "\t", header = TRUE, stringsAsFactors = FALSE)

meta_data <- read.csv("Treatment_metadata.csv", stringsAsFactors = FALSE)
colnames(meta_data)[1] <- "Sample.ID"
```
##Part 1 Cc vs Dc (symbiont contribution)

#Keep only Control samples and allow only 1 NA 
```{r}
df <- data.frame() #create empty data frame to bind filtered rows into
for(i in (1:nrow(allsamples_DMR))){
  Cc <- allsamples_DMR[i,7:11] #define columns from the category CC
  Dc <- allsamples_DMR[i,19:24] #define columns from the category BC
     if(length(which(is.na(Cc))) < 2 & length(which(is.na(Dc))) < 2){
  df <- rbind(df,allsamples_DMR[i,]) #conditional statement: if less than 2 samples/category have NA for % methylation bind the whole row to the new dataframe
  }
}
#save df as a specific variable
Control_DMR <- df
Control_DMR <- Control_DMR[,c(1:11,19:24)]
```

# Run group statistics on regions to find regions that are significantly different among symbionts

Make a unique ID column 
```{r}
Control_DMR$ID <- paste(Control_DMR$`#chr`,":",Control_DMR$start,"-",Control_DMR$end, sep = "")
Control_DMR$ID <- gsub("__.*__.*:",":",Control_DMR$ID)
```

reformat data for calculating group effect
```{r}
#reformat all to long format
Control_DMR_STACKED <- tidyr::gather(Control_DMR[,7:ncol(Control_DMR)], "Sample.ID", "perc.meth",1:11)

#simplify sample ID column
Control_DMR_STACKED$Sample.ID <- gsub("methylation_level_","", Control_DMR_STACKED$Sample.ID)

#merge with meta data
Control_DMR_STACKED <- merge(Control_DMR_STACKED, meta_data, by = "Sample.ID")
#create a group variable for the combination of treatments
Control_DMR_STACKED <- Control_DMR_STACKED %>%
  mutate(sym = recode(trt1, b = "D", c = "C"),
         group = paste(sym, trt2, sep = ""))
Control_DMR_STACKED <- Control_DMR_STACKED[-7]

```

arc sin sqrt transform the data
```{r}
#arcsin sqrt transformation function
asinTransform <- function(p) { asin(sqrt(p))}

#arcsin transform data 
Control_DMR_STACKED_asin <- Control_DMR_STACKED
Control_DMR_STACKED_asin$perc.meth <- asinTransform(Control_DMR_STACKED_asin$perc.meth)
```

## One-way anova
**Hypotehsis: there is no effect of symbiont
```{r}
Control_DMR_1way_aov <- Control_DMR_STACKED_asin %>% group_by(ID) %>%
do(meth_aov_models = aov(perc.meth~group, data =  . ))
#summarize ANOVA data
Control_DMR_1way_aov_modelsumm  <- Control_DMR_1way_aov %>% ungroup %>% 
    pull(meth_aov_models) %>% 
    map_dfr(tidy, .id = 'grp')
#spread out pvalues
Control_DMR_1way_aov_modelsumm_wide <- data.frame(tidyr::pivot_wider(Control_DMR_1way_aov_modelsumm, names_from = term, values_from = c("df", "sumsq", "meansq","statistic","p.value"),names_sep = "_" ))
Control_DMR_1way_aov_modelsumm_wide <- cbind(Control_DMR_1way_aov[,1], Control_DMR_1way_aov_modelsumm_wide[,-c(1)])
Control_DMR_1way_aov_modelsumm_wide[which(Control_DMR_1way_aov_modelsumm_wide$p.value_group <= 0.05), 1]

```
plot heatmap of Permanova for sym p.val 0.05 sig DMRs
```{r}
#create matrix for Cc vs Dc
aov_0.05_Ctrols_DMR_m <- as.matrix(Control_DMR[,7:17])
rownames(aov_0.05_Ctrols_DMR_m) <- Control_DMR$ID
aov_0.05_Ctrols_DMR_m <- aov_0.05_Ctrols_DMR_m[which(rownames(aov_0.05_Ctrols_DMR_m) %in% pull(Control_DMR_1way_aov_modelsumm_wide[which(Control_DMR_1way_aov_modelsumm_wide$p.value_group<= 0.05),],ID)),]

#remove extra text from column names
colnames(aov_0.05_Ctrols_DMR_m) <- gsub("methylation_level_","",colnames(aov_0.05_Ctrols_DMR_m))

#plot for Control groups mean comparison

jpeg("Output/1.2_alignment/all.aov_0.05_CcDc_heatmap.jpg", width = 600, height = 1000)
heatmap.2(aov_0.05_Ctrols_DMR_m,margins = c(10,20), cexCol = 2, distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'),key.xtickfun = function() {
  breaks = pretty(parent.frame()$breaks)
  #breaks = breaks[c(1,length(breaks))]
  list(at = parent.frame()$scale01(breaks),labels = breaks)},Colv=NA, col= rev(colorRampPalette(brewer.pal(10, "RdYlBu"))(256)), density.info = "none", trace = "none", scale = "row", labRow = FALSE,sepwidth=c(0.01,0.01),sepcolor="white",colsep=1:ncol(aov_0.05_Ctrols_DMR_m),rowsep=1:nrow(aov_0.05_Ctrols_DMR_m),lmat = rbind(c(0,3),c(2,1),c(4,0)),keysize=0.5, key.par = list(cex=1),lhei=c(1.5,4,1), lwid = c(1.5,4))
dev.off()
```

# Part 2: Cc vs Ch comparizon (temp effect C-symb)

Keep only C-symb samples and allow only 1 NA 
```{r}
df <- data.frame() #create empty data frame to bind filtered rows into
for(i in (1:nrow(allsamples_DMR))){
  Cc <- allsamples_DMR[i,7:11] #define columns from the category CC
  Ch <- allsamples_DMR[i,12:18] #define columns from the category BC
     if(length(which(is.na(Cc))) < 2 & length(which(is.na(Ch))) < 2){
  df <- rbind(df,allsamples_DMR[i,]) #conditional statement: if less than 2 samples/category have NA for % methylation bind the whole row to the new dataframe
  }
}
#save df as a specific variable
C_symb_DMR <- df
C_symb_DMR <- C_symb_DMR[,c(1:18)]
```

# Part 2: Run group statistics on regions to find regions that are significantly different among treatments for C_symb

Make a unique ID column 
```{r}
C_symb_DMR$ID <- paste(C_symb_DMR$`#chr`,":",C_symb_DMR$start,"-",C_symb_DMR$end, sep = "")
C_symb_DMR$ID <- gsub("__.*__.*:",":",C_symb_DMR$ID)
```

reformat data for calculating group effect
```{r}
#reformat all to long format
C_symb_DMR_STACKED <- tidyr::gather(C_symb_DMR[,7:ncol(C_symb_DMR)], "Sample.ID", "perc.meth",1:11)

#simplify sample ID column
C_symb_DMR_STACKED$Sample.ID <- gsub("methylation_level_","", C_symb_DMR_STACKED$Sample.ID)

#merge with meta data
C_symb_DMR_STACKED <- merge(C_symb_DMR_STACKED, meta_data, by = "Sample.ID")
#create a group variable for the combination of treatments
C_symb_DMR_STACKED <- C_symb_DMR_STACKED %>%
  mutate(sym = recode(trt1, b = "D", c = "C"),
         group = paste(sym, trt2, sep = ""))
C_symb_DMR_STACKED <- C_symb_DMR_STACKED[-7]

```

arc sin sqrt transform the data
```{r}
#arcsin sqrt transformation function
asinTransform <- function(p) { asin(sqrt(p))}

#arcsin transform data 
C_symb_DMR_STACKED_asin <- C_symb_DMR_STACKED
C_symb_DMR_STACKED_asin$perc.meth <- asinTransform(C_symb_DMR_STACKED_asin$perc.meth)
```

## One-way anova
**Hypotehsis: there is no effect of temeparure on symbiont C
```{r}
C_symb_DMR_1way_aov <- C_symb_DMR_STACKED_asin %>% group_by(ID) %>%
do(meth_aov_models = aov(perc.meth~group, data =  . ))
#summarize ANOVA data
C_symb_DMR_1way_aov_modelsumm  <- C_symb_DMR_1way_aov %>% ungroup %>% 
    pull(meth_aov_models) %>% 
    map_dfr(tidy, .id = 'grp')
#spread out pvalues
C_symb_DMR_1way_aov_modelsumm_wide <- data.frame(tidyr::pivot_wider(C_symb_DMR_1way_aov_modelsumm, names_from = term, values_from = c("df", "sumsq", "meansq","statistic","p.value"),names_sep = "_" ))
C_symb_DMR_1way_aov_modelsumm_wide <- cbind(C_symb_DMR_1way_aov[,1], C_symb_DMR_1way_aov_modelsumm_wide[,-c(1)])
C_symb_DMR_1way_aov_modelsumm_wide[which(C_symb_DMR_1way_aov_modelsumm_wide$p.value_group <= 0.05), 1]

```
plot heatmap of Anova for C_symb p.val 0.05 sig DMRs
```{r}
#create matrix for Cc vs Dc
aov_0.05_C_symb_DMR_m <- as.matrix(C_symb_DMR[,7:18])
rownames(aov_0.05_C_symb_DMR_m) <- C_symb_DMR$ID
aov_0.05_C_symb_DMR_m <- aov_0.05_C_symb_DMR_m[which(rownames(aov_0.05_C_symb_DMR_m) %in% pull(C_symb_DMR_1way_aov_modelsumm_wide[which(C_symb_DMR_1way_aov_modelsumm_wide$p.value_group<= 0.05),],ID)),]

#remove extra text from column names
colnames(aov_0.05_C_symb_DMR_m) <- gsub("methylation_level_","",colnames(aov_0.05_C_symb_DMR_m))

#plot for Control groups mean comparison

jpeg("Output/1.2_alignment/all.aov_0.05_CcCh_mod_heatmap.jpg", width = 600, height = 1000)
heatmap.2(aov_0.05_C_symb_DMR_m,margins = c(10,20), cexCol = 2, distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'),key.xtickfun = function() {
  breaks = pretty(parent.frame()$breaks)
  #breaks = breaks[c(1,length(breaks))]
  list(at = parent.frame()$scale01(breaks),labels = breaks)},Colv=NA, col= rev(colorRampPalette(brewer.pal(10, "RdYlBu"))(256)), density.info = "none", trace = "none", scale = "row", labRow = FALSE,sepwidth=c(0.01,0.01),sepcolor="white",colsep=1:ncol(aov_0.05_C_symb_DMR_m),rowsep=1:nrow(aov_0.05_C_symb_DMR_m),lmat = rbind(c(0,3),c(2,1),c(4,0)),keysize=0.5, key.par = list(cex=1),lhei=c(1.5,4,1), lwid = c(1.5,4))
dev.off()
```

# Part 3: Dc vs Dh comparizon (temp effect D-symb)

Keep only C-symb samples and allow only 1 NA 
```{r}
df <- data.frame() #create empty data frame to bind filtered rows into
for(i in (1:nrow(allsamples_DMR))){
  Dc <- allsamples_DMR[i,19:24] #define columns from the category CC
  Ch <- allsamples_DMR[i,25:30] #define columns from the category BC
     if(length(which(is.na(Dc))) < 2 & length(which(is.na(Dh))) < 2){
  df <- rbind(df,allsamples_DMR[i,]) #conditional statement: if less than 2 samples/category have NA for % methylation bind the whole row to the new dataframe
  }
}
#save df as a specific variable
D_symb_DMR <- df
D_symb_DMR <- D_symb_DMR[,c(1:6,19:30)]
```

Run group statistics on regions to find regions that are significantly different among treatments for symb_D

Make a unique ID column 
```{r}
D_symb_DMR$ID <- paste(D_symb_DMR$`#chr`,":",D_symb_DMR$start,"-",D_symb_DMR$end, sep = "")
D_symb_DMR$ID <- gsub("__.*__.*:",":",D_symb_DMR$ID)
```

reformat data for calculating group effect
```{r}
#reformat all to long format
D_symb_DMR_STACKED <- tidyr::gather(D_symb_DMR[,7:ncol(D_symb_DMR)], "Sample.ID", "perc.meth",1:12)

#simplify sample ID column
D_symb_DMR_STACKED$Sample.ID <- gsub("methylation_level_","", D_symb_DMR_STACKED$Sample.ID)

#merge with meta data
D_symb_DMR_STACKED <- merge(D_symb_DMR_STACKED, meta_data, by = "Sample.ID")
#create a group variable for the combination of treatments
D_symb_DMR_STACKED <- D_symb_DMR_STACKED %>%
  mutate(sym = recode(trt1, b = "D", c = "C"),
         group = paste(sym, trt2, sep = ""))
D_symb_DMR_STACKED <- D_symb_DMR_STACKED[-7]

```

arc sin sqrt transform the data
```{r}
#arcsin sqrt transformation function
asinTransform <- function(p) { asin(sqrt(p))}

#arcsin transform data 
D_symb_DMR_STACKED_asin <- D_symb_DMR_STACKED
D_symb_DMR_STACKED_asin$perc.meth <- asinTransform(D_symb_DMR_STACKED_asin$perc.meth)
```

## One-way anova
**Hypotehsis: there is no effect of temperature
```{r}
D_symb_DMR_1way_aov <- D_symb_DMR_STACKED_asin %>% group_by(ID) %>%
do(meth_aov_models = aov(perc.meth~group, data =  . ))
#summarize ANOVA data
D_symb_DMR_1way_aov_modelsumm  <- D_symb_DMR_1way_aov %>% ungroup %>% 
    pull(meth_aov_models) %>% 
    map_dfr(tidy, .id = 'grp')
#spread out pvalues
D_symb_DMR_1way_aov_modelsumm_wide <- data.frame(tidyr::pivot_wider(D_symb_DMR_1way_aov_modelsumm, names_from = term, values_from = c("df", "sumsq", "meansq","statistic","p.value"),names_sep = "_" ))
D_symb_DMR_1way_aov_modelsumm_wide <- cbind(D_symb_DMR_1way_aov[,1], D_symb_DMR_1way_aov_modelsumm_wide[,-c(1)])
D_symb_DMR_1way_aov_modelsumm_wide[which(D_symb_DMR_1way_aov_modelsumm_wide$p.value_group <= 0.05), 1]

```
plot heatmap of Anova for sym-D p.val 0.05 sig DMRs
```{r}
#create matrix for Cc vs Dc
aov_0.05_D_symb_DMR_m <- as.matrix(D_symb_DMR[,7:18])
rownames(aov_0.05_D_symb_DMR_m) <- D_symb_DMR$ID
aov_0.05_D_symb_DMR_m <- aov_0.05_D_symb_DMR_m[which(rownames(aov_0.05_D_symb_DMR_m) %in% pull(D_symb_DMR_1way_aov_modelsumm_wide[which(D_symb_DMR_1way_aov_modelsumm_wide$p.value_group<= 0.05),],ID)),]

#remove extra text from column names
colnames(aov_0.05_D_symb_DMR_m) <- gsub("methylation_level_","",colnames(aov_0.05_D_symb_DMR_m))

#plot for Control groups mean comparison

jpeg("Output/1.2_alignment/all.aov_0.05_DcDh_heatmap.jpg", width = 600, height = 1000)
heatmap.2(aov_0.05_D_symb_DMR_m,margins = c(10,20), cexCol = 2, distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'),key.xtickfun = function() {
  breaks = pretty(parent.frame()$breaks)
  #breaks = breaks[c(1,length(breaks))]
  list(at = parent.frame()$scale01(breaks),labels = breaks)},Colv=NA, col= rev(colorRampPalette(brewer.pal(10, "RdYlBu"))(256)), density.info = "none", trace = "none", scale = "row", labRow = FALSE,sepwidth=c(0.01,0.01),sepcolor="white",colsep=1:ncol(aov_0.05_D_symb_DMR_m),rowsep=1:nrow(aov_0.05_D_symb_DMR_m),lmat = rbind(c(0,3),c(2,1),c(4,0)),keysize=0.5, key.par = list(cex=1),lhei=c(1.5,4,1), lwid = c(1.5,4))
dev.off()

```
# Part 4: Ch vs Dh comparizon (differential temp effect by symbiont)

Keep only Heated samples and allow only 1 NA 
```{r}
df <- data.frame() #create empty data frame to bind filtered rows into
for(i in (1:nrow(allsamples_DMR))){
  Ch <- allsamples_DMR[i,12:18] #define columns from the category CC
  Dh <- allsamples_DMR[i,25:30] #define columns from the category BC
     if(length(which(is.na(Ch))) < 2 & length(which(is.na(Dh))) < 2){
  df <- rbind(df,allsamples_DMR[i,]) #conditional statement: if less than 2 samples/category have NA for % methylation bind the whole row to the new dataframe
  }
}
#save df as a specific variable
Heated_DMR <- df
Heated_DMR <- Heated_DMR[,c(1:6,12:18,25:30)]
```


# Run group statistics on regions to find regions that are significantly different among symbionts
Make a unique ID column 
```{r}
Heated_DMR$ID <- paste(Heated_DMR$`#chr`,":",Heated_DMR$start,"-",Heated_DMR$end, sep = "")
Heated_DMR$ID <- gsub("__.*__.*:",":",Heated_DMR$ID)
```

reformat data for calculating group effect
```{r}
#reformat all to long format
Heated_DMR_STACKED <- tidyr::gather(Heated_DMR[,7:ncol(Heated_DMR)], "Sample.ID", "perc.meth",1:13)

#simplify sample ID column
Heated_DMR_STACKED$Sample.ID <- gsub("methylation_level_","", Heated_DMR_STACKED$Sample.ID)

#merge with meta data
Heated_DMR_STACKED <- merge(Heated_DMR_STACKED, meta_data, by = "Sample.ID")
#create a group variable for the combination of treatments
Heated_DMR_STACKED <- Heated_DMR_STACKED %>%
  mutate(sym = recode(trt1, b = "D", c = "C"),
         group = paste(sym, trt2, sep = ""))
Heated_DMR_STACKED <- Heated_DMR_STACKED[-7]

```

arc sin sqrt transform the data
```{r}
#arcsin sqrt transformation function
asinTransform <- function(p) { asin(sqrt(p))}

#arcsin transform data 
Heated_DMR_STACKED_asin <- Heated_DMR_STACKED
Heated_DMR_STACKED_asin$perc.meth <- asinTransform(Heated_DMR_STACKED_asin$perc.meth)
```

## One-way anova
**Hypotehsis: there is no effect of symbiont
```{r}
Heated_DMR_1way_aov <- Heated_DMR_STACKED_asin %>% group_by(ID) %>%
do(meth_aov_models = aov(perc.meth~group, data =  . ))
#summarize ANOVA data
Heated_DMR_1way_aov_modelsumm  <- Heated_DMR_1way_aov %>% ungroup %>% 
    pull(meth_aov_models) %>% 
    map_dfr(tidy, .id = 'grp')
#spread out pvalues
Heated_DMR_1way_aov_modelsumm_wide <- data.frame(tidyr::pivot_wider(Heated_DMR_1way_aov_modelsumm, names_from = term, values_from = c("df", "sumsq", "meansq","statistic","p.value"),names_sep = "_" ))
Heated_DMR_1way_aov_modelsumm_wide <- cbind(Heated_DMR_1way_aov[,1], Heated_DMR_1way_aov_modelsumm_wide[,-c(1)])
Heated_DMR_1way_aov_modelsumm_wide[which(Heated_DMR_1way_aov_modelsumm_wide$p.value_group <= 0.05), 1]

```

plot heatmap of Anova for Heat treatment p.val 0.05 sig DMRs
```{r}
#create matrix for Cc vs Dc
aov_0.05_Heated_DMR_m <- as.matrix(Heated_DMR[,7:19])
rownames(aov_0.05_Heated_DMR_m) <- Heated_DMR$ID
aov_0.05_Heated_DMR_m <- aov_0.05_Heated_DMR_m[which(rownames(aov_0.05_Heated_DMR_m) %in% pull(Heated_DMR_1way_aov_modelsumm_wide[which(Heated_DMR_1way_aov_modelsumm_wide$p.value_group<= 0.05),],ID)),]

#remove extra text from column names
colnames(aov_0.05_Heated_DMR_m) <- gsub("methylation_level_","",colnames(aov_0.05_Heated_DMR_m))

#plot for Control groups mean comparison

jpeg("Output/1.2_alignment/all.aov_0.05_ChDh_heatmap.jpg", width = 600, height = 1000)
heatmap.2(aov_0.05_Heated_DMR_m,margins = c(10,20), cexCol = 2, distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'),key.xtickfun = function() {
  breaks = pretty(parent.frame()$breaks)
  #breaks = breaks[c(1,length(breaks))]
  list(at = parent.frame()$scale01(breaks),labels = breaks)},Colv=NA, col= rev(colorRampPalette(brewer.pal(10, "RdYlBu"))(256)), density.info = "none", trace = "none", scale = "row", labRow = FALSE,sepwidth=c(0.01,0.01),sepcolor="white",colsep=1:ncol(aov_0.05_Heated_DMR_m),rowsep=1:nrow(aov_0.05_Heated_DMR_m),lmat = rbind(c(0,3),c(2,1),c(4,0)),keysize=0.5, key.par = list(cex=1),lhei=c(1.5,4,1), lwid = c(1.5,4))
dev.off()
```

# Part 5: all comparizons together
```{r}
#create matrix for Cc vs Dc
aov_0.05_Ctrols_DMR <- as.matrix(all_DMR[,7:30])
rownames(aov_0.05_Ctrols_DMR) <- all_DMR$ID
aov_0.05_Ctrols_DMR <- aov_0.05_Ctrols_DMR[which(rownames(aov_0.05_Ctrols_DMR) %in% pull(Control_DMR_1way_aov_modelsumm_wide[which(Control_DMR_1way_aov_modelsumm_wide$p.value_group<= 0.05),],ID)),]
#create matrix for Cc vs Ch
aov_0.05_C_symb_DMR <- as.matrix(all_DMR[,7:30])
rownames(aov_0.05_C_symb_DMR) <- all_DMR$ID
aov_0.05_C_symb_DMR <- aov_0.05_C_symb_DMR[which(rownames(aov_0.05_C_symb_DMR) %in% pull(C_symb_DMR_1way_aov_modelsumm_wide[which(C_symb_DMR_1way_aov_modelsumm_wide$p.value_group<= 0.05),],ID)),]
#create matrix for Dc vs Dh
aov_0.05_D_symb_DMR <- as.matrix(all_DMR[,7:30])
rownames(aov_0.05_D_symb_DMR) <- all_DMR$ID
aov_0.05_D_symb_DMR <- aov_0.05_D_symb_DMR[which(rownames(aov_0.05_D_symb_DMR) %in% pull(D_symb_DMR_1way_aov_modelsumm_wide[which(D_symb_DMR_1way_aov_modelsumm_wide$p.value_group<= 0.05),],ID)),]
#create matrix for Ch vs Dh
aov_0.05_Heated_DMR <- as.matrix(all_DMR[,7:30])
rownames(aov_0.05_Heated_DMR) <- all_DMR$ID
aov_0.05_Heated_DMR <- aov_0.05_Heated_DMR[which(rownames(aov_0.05_Heated_DMR) %in% pull(Heated_DMR_1way_aov_modelsumm_wide[which(Heated_DMR_1way_aov_modelsumm_wide$p.value_group<= 0.05),],ID)),]

#bind all significant loci
aov_0.05_merged_DMR <- as.data.frame(rbind(aov_0.05_Ctrols_DMR, aov_0.05_C_symb_DMR, aov_0.05_D_symb_DMR, aov_0.05_Heated_DMR))

duplicated(rownames(aov_0.05_merged_DMR)) 

sig_merged_DMR <- as.factor(rownames(aov_0.05_merged_DMR))

#calculate group means
MeanC <- rowMeans(aov_0.05_merged_DMR[,grep("CC", colnames(aov_0.05_merged_DMR))], na.rm = TRUE)
MeanD <- rowMeans(aov_0.05_merged_DMR[,grep("BC", colnames(aov_0.05_merged_DMR))], na.rm = TRUE)
MeanCc <- rowMeans(aov_0.05_merged_DMR[,grep("CC", colnames(aov_0.05_merged_DMR))], na.rm = TRUE)
MeanCh <- rowMeans(aov_0.05_merged_DMR[,grep("CH", colnames(aov_0.05_merged_DMR))], na.rm = TRUE)
MeanDc <- rowMeans(aov_0.05_merged_DMR[,grep("BC", colnames(aov_0.05_merged_DMR))], na.rm = TRUE)
MeanDh <- rowMeans(aov_0.05_merged_DMR[,grep("BH", colnames(aov_0.05_merged_DMR))], na.rm = TRUE)
MeanC_h <- rowMeans(aov_0.05_merged_DMR[,grep("CH", colnames(aov_0.05_merged_DMR))], na.rm = TRUE)
MeanD_h <- rowMeans(aov_0.05_merged_DMR[,grep("BH", colnames(aov_0.05_merged_DMR))], na.rm = TRUE)

#bind all group means together
aov_0.05_merged_DMR_mean <- as.matrix(data.frame(cbind(MeanC,MeanD,MeanCc,MeanCh,MeanDc,MeanDh,MeanC_h,MeanD_h)))

#plot for all group mean comparison
colnames(aov_0.05_merged_DMR_mean ) <- c("SymbC_Control", "SymbD_Control", "SymbC_Control", "SymbC_Heated","SymbD_Control", "SymbD_Heated","SymbC_Heated", "SymbD_Heated")
jpeg("Output/1.2_alignment/all.comp_all_0.05_DMR_heatmap.jpg", width = 600, height = 1000)
heatmap.2(aov_0.05_merged_DMR_mean,margins = c(10,13), cexCol = 1.5, distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'),key.xtickfun = function() {
  breaks = pretty(parent.frame()$breaks)
  #breaks = breaks[c(1,length(breaks))]
  list(at = parent.frame()$scale01(breaks),labels = breaks)},Colv=NA, col= rev(colorRampPalette(brewer.pal(10, "RdYlBu"))(256)), lmat = rbind(c(0,3),c(2,1),c(4,0)),na.color = "black", density.info = "none", trace = "none", scale = "row", keysize=0.5, key.par = list(cex=1),labRow = FALSE,sepwidth=c(0.2,0.00001), lhei=c(1.5,4,1),lwid= c(1.5, 4),sepcolor="white",colsep=seq(2,ncol(aov_0.05_merged_DMR_mean),2),rowsep=NULL)
dev.off()
```

