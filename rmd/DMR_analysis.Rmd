---
title: "One-one_comparizon_DMR"
author: "Javier Rodriguez-Casariego"
date: "12/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

load libraries
```{r}
library(data.table)
library(gplots)
library(ggplot2) #install.packages('ggplot2')
library(dplyr)
library(broom)
library(RColorBrewer)
library(egg) #install.packages('egg')
library(purrr)
library(nlme)
library(vegan)
```
# All samples analysis
# allow only 1NA per treatment group for each region
```{r}
allsamples_DMR <- fread('../analyses/DMR_output/DMR_files/alltreat_DMR250bp_cov5x_rms_results_collapsed.tsv', sep = "\t", header = TRUE, stringsAsFactors = FALSE)

meta_data <- read.csv("../data/Treatment_metadata.csv", stringsAsFactors = FALSE)
meta_data <- meta_data[,c(3:11)]
colnames(meta_data) <- c("species", "colony", "core", "sample", "trt1", "trt2", "TreatComb", "Tank","Sample.ID")

df <- data.frame() #create empty data frame to bind filtered rows into
for(i in (1:nrow(allsamples_DMR))){
  Cc <- allsamples_DMR[i,7:11] #define columns from the category CC
  Ch <- allsamples_DMR[i,12:17] #define columns from the category CH
  Dc <- allsamples_DMR[i,19:24] #define columns from the category BC
  Dh <- allsamples_DMR[i,25:30] #define columns from the category BH
    if(length(which(is.na(Cc))) < 2 & length(which(is.na(Ch))) < 2 & length(which(is.na(Dc))) < 2 & length(which(is.na(Dh))) < 2){
  df <- rbind(df,allsamples_DMR[i,]) #conditional statement: if less than 2 samples/category have NA for % methylation bind the whole row to the new dataframe
  }
}
#save df as a specific variable
all_DMR <- df
all_DMR <- all_DMR[,c(1:30)]
#make a unique ID collumn (scaff-position)
all_DMR$ID <- paste(all_DMR$`#chr`,":",all_DMR$start,"-",all_DMR$end, sep = "")
all_DMR$ID <- gsub("__.*__.*:",":",all_DMR$ID)
all_DMR <- all_DMR[,-18]
```

# Run group statistics on regions to find regions that are significantly different among symbionts*temperatures

```{r}
#reformat all to long format
all_DMR_STACKED <- tidyr::gather(all_DMR[,7:ncol(all_DMR)], "Sample.ID", "perc.meth", 1:23)

#simplify sample ID column
all_DMR_STACKED$Sample.ID <- gsub("methylation_level_","", all_DMR_STACKED$Sample.ID)

#merge with meta data
all_DMR_STACKED <- merge(all_DMR_STACKED, meta_data, by = "Sample.ID")
#create a group variable for the combination of treatments
all_DMR_STACKED <- all_DMR_STACKED %>%
  mutate(sym = recode(trt1, b = "D", c = "C"),
         group = paste(sym, trt2, sep = ""))
all_DMR_STACKED <- all_DMR_STACKED[-7]

```

arc sin sqrt transform the data
```{r}
#arcsin sqrt transformation function
asinTransform <- function(p) { asin(sqrt(p))}

#arcsin transform data 
all_DMR_STACKED_asin <- all_DMR_STACKED
all_DMR_STACKED_asin$perc.meth <- asinTransform(all_DMR_STACKED_asin$perc.meth)
```

two-way_ANOVA
**Hypotehsis: there is no effect of symbiont, temperature or their interaction on each loci
```{r}
all_DMR_2way_aov <- all_DMR_STACKED_asin %>% group_by(ID) %>%
do(meth_aov_models = aov(perc.meth~sym*trt2, data =  . ))
#summarize ANOVA data
all_DMR_2way_aov_modelsumm  <- all_DMR_2way_aov %>% ungroup %>% 
    pull(meth_aov_models) %>% 
    map_dfr(tidy, .id = 'grp')
#spread out pvalues
all_DMR_2way_aov_modelsumm_wide <- data.frame(tidyr::pivot_wider(all_DMR_2way_aov_modelsumm, names_from = term, values_from = c("df", "sumsq", "meansq","statistic","p.value"),names_sep = "_" ))
all_DMR_2way_aov_modelsumm_wide <- cbind(all_DMR_2way_aov[,1], all_DMR_2way_aov_modelsumm_wide[,-c(1)])
all_aov_sig_DMR_Symb <- all_DMR_2way_aov_modelsumm_wide[which(all_DMR_2way_aov_modelsumm_wide$p.value_sym <= 0.05), 1]
all_aov_sig_DMR_Temp <- all_DMR_2way_aov_modelsumm_wide[which(all_DMR_2way_aov_modelsumm_wide$p.value_trt2 <= 0.05), 1]
all_aov_sig_DMR_Inter <- all_DMR_2way_aov_modelsumm_wide[which(all_DMR_2way_aov_modelsumm_wide$p.value_sym.trt2 <= 0.05), 1]
```

plot heatmap of all Anova p.val 0.05 sig DMRs
```{r}
#create matrix for all sig DMR
all_aov_sig_DMR_m <- as.matrix(all_DMR[,7:29])
rownames(all_aov_sig_DMR_m) <- all_DMR$ID
all_aov_sig_DMR_m <- all_aov_sig_DMR_m[which(rownames(all_aov_sig_DMR_m) %in% pull(all_DMR_2way_aov_modelsumm_wide[which(all_DMR_2way_aov_modelsumm_wide$p.value_sym<= 0.05 | all_DMR_2way_aov_modelsumm_wide$p.value_trt2<= 0.05 | all_DMR_2way_aov_modelsumm_wide$p.value_sym.trt2<= 0.05),],ID)),]

#Create a vector with the IDs of all significant DMRs in the same order as feed into the matrix
all_aov_sig_DMR <- all_DMR_2way_aov_modelsumm_wide[which(all_DMR_2way_aov_modelsumm_wide$p.value_sym<= 0.05 | all_DMR_2way_aov_modelsumm_wide$p.value_trt2<= 0.05 | all_DMR_2way_aov_modelsumm_wide$p.value_sym.trt2<= 0.05), 1]

#create function for shared DMRs
set.intersection <- function(a, b) {
  intersect <- vector()

  for (i in 1:length(a)) {
    if (a[i] %in% b) {
      intersect <- append(intersect, a[i])
    }
  }
  return(intersect)
}

symb_temp_shared_sig_DMR <- set.intersection(all_aov_sig_DMR_Symb, all_aov_sig_DMR_Temp) 
symb_inter_shared_sig_DMR <- set.intersection(all_aov_sig_DMR_Symb, all_aov_sig_DMR_Inter)
temp_inter_shared_sig_DMR <- set.intersection(all_aov_sig_DMR_Temp, all_aov_sig_DMR_Inter)


#remove extra text from column names
colnames(all_aov_sig_DMR_m ) <- gsub("methylation_level_","",colnames(all_aov_sig_DMR_m ))

sig_merged_DMR <- as.factor(rownames(all_aov_sig_DMR_m))

#plot for groups mean comparison

MeanC <- rowMeans(all_aov_sig_DMR_m[,grep("CC", colnames(all_aov_sig_DMR_m))], na.rm = TRUE)
MeanD <- rowMeans(all_aov_sig_DMR_m[,grep("BC", colnames(all_aov_sig_DMR_m))], na.rm = TRUE)
MeanCh <- rowMeans(all_aov_sig_DMR_m[,grep("CH", colnames(all_aov_sig_DMR_m))], na.rm = TRUE)
MeanDh <- rowMeans(all_aov_sig_DMR_m[,grep("BH", colnames(all_aov_sig_DMR_m))], na.rm = TRUE)


aov_all.0.05_merged_DMR_mean <- as.matrix(data.frame(cbind(MeanC,MeanD,MeanCh,MeanDh)))

#plot for all group mean comparison
colnames(aov_all.0.05_merged_DMR_mean ) <- c("SymbC_Control", "SymbD_Control", "SymbC_Heated", "SymbD_Heated")
jpeg("../output/figures/all.0.05_DMR_heatmap.jpg", width = 1200, height = 2000)
HM <- heatmap(aov_all.0.05_merged_DMR_mean,margins = c(10,20), cexCol = 2, distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'),key.xtickfun = function() {
  breaks = pretty(parent.frame()$breaks)
  breaks = breaks[c(1,length(breaks))]
  list(at = parent.frame()$scale01(breaks),labels = breaks)},Colv=NA, col= rev(colorRampPalette(brewer.pal(10, "RdYlBu"))(256)), density.info = "none", trace = "none", scale = "row", labRow = TRUE,sepwidth=c(0.01,0.01),sepcolor="white",colsep=1:ncol(all_aov_sig_DMR_m),rowsep=1:nrow(all_aov_sig_DMR_m),lmat = rbind(c(0,3),c(2,1),c(4,0)),keysize=0.5, key.par = list(cex=1),lhei=c(1.5,4,1), lwid = c(1.5,4))
dev.off()

a_clust <- HM$rowInd[1:40]
b_clust <- HM$rowInd[41:67]
c_clust <- HM$rowInd[68:113]
d_clust <- HM$rowInd[114:173]
e_clust <- HM$rowInd[174:206]
all_a_Clust <- all_aov_sig_DMR[a_clust]
all_b_Clust <- all_aov_sig_DMR[b_clust]
all_c_Clust <- all_aov_sig_DMR[c_clust]
all_d_Clust <- all_aov_sig_DMR[d_clust]
all_e_Clust <- all_aov_sig_DMR[e_clust]

# find shared DMRs

shared_DMR_Symb_temp <- intersect(all_aov_sig_DMR_Symb, all_aov_sig_DMR_Temp)
shared_DMR_Symb_Inter <- intersect(all_aov_sig_DMR_Symb, all_aov_sig_DMR_Inter)
shared_DMR_Inter_temp <- intersect(all_aov_sig_DMR_Inter, all_aov_sig_DMR_Temp)
shared_DMR_all <- intersect(all_aov_sig_DMR_Symb, all_aov_sig_DMR_Temp) %>% 
  intersect(., all_aov_sig_DMR_Inter)

#Create Venn Diagram of DMR_general model
library(VennDiagram)
myCol <- brewer.pal(3, "Pastel1")
venn.diagram(
        x = list(all_aov_sig_DMR_Symb, all_aov_sig_DMR_Temp, all_aov_sig_DMR_Inter),
        category.names = c("Symb" , "Temp " , "Symb:Temp"),
        filename = '../output/other/DMR_GM_venn_diagramm.png',
        output=TRUE,
        
        # Output features
        imagetype="png" ,
        height = 480 , 
        width = 480 , 
        resolution = 300,
        compression = "lzw",
        
        # Circles
        lwd = 2,
        lty = 'blank',
        fill = myCol,
        
        # Numbers
        cex = .6,
        fontface = "bold",
        fontfamily = "sans",
        
        # Set names
        cat.cex = 0.4,
        cat.fontface = "bold",
        cat.default.pos = "outer",
        cat.pos = c(-175, 0, 175),
        cat.fontfamily = "sans",
        rotation = 1
)

```

Create bed files for general model comparison
```{r}
#subset model data for scaffold start and end positions for DMRs significant at p < 0.05
all_symb_sig.bed <- data_frame(all_aov_sig_DMR_Symb)%>%
  separate(all_aov_sig_DMR_Symb, sep=":", into = c("scaffold", "pos")) %>%
  separate(pos, sep="-", into = c("start", "end"))
all_temp_sig.bed <- data_frame(all_aov_sig_DMR_Temp)%>%
  separate(all_aov_sig_DMR_Temp, sep=":", into = c("scaffold", "pos")) %>%
  separate(pos, sep="-", into = c("start", "end"))
all_Inter_sig.bed <- data_frame(all_aov_sig_DMR_Inter)%>%
  separate(all_aov_sig_DMR_Inter, sep=":", into = c("scaffold", "pos")) %>%
  separate(pos, sep="-", into = c("start", "end"))

#subset for DMRs in each cluster of general heatmap
all.a_clust_sig.bed <- data.frame(all_a_Clust) %>%
  separate(all_a_Clust, sep=":", into = c("scaffold", "pos")) %>%
  separate(pos, sep="-", into = c("start", "end"))
all.b_clust_sig.bed <- data.frame(all_b_Clust) %>%
  separate(all_b_Clust, sep=":", into = c("scaffold", "pos")) %>%
  separate(pos, sep="-", into = c("start", "end"))
all.c_clust_sig.bed <- data.frame(all_c_Clust) %>%
  separate(all_c_Clust, sep=":", into = c("scaffold", "pos")) %>%
  separate(pos, sep="-", into = c("start", "end"))
all.d_clust_sig.bed <- data.frame(all_d_Clust) %>%
  separate(all_d_Clust, sep=":", into = c("scaffold", "pos")) %>%
  separate(pos, sep="-", into = c("start", "end"))
all.e_clust_sig.bed <- data.frame(all_e_Clust) %>%
  separate(all_e_Clust, sep=":", into = c("scaffold", "pos")) %>%
  separate(pos, sep="-", into = c("start", "end"))

#write out data
write.table(all_Inter_sig.bed, "../analyses/DMR_output/bed/all_Inter_sig.bed", sep = "\t",row.names = F, col.names = F, quote = F)
write.table(all_symb_sig.bed, "../analyses/DMR_output/bed/all_symb_sig.bed", sep = "\t",row.names = F, col.names = F, quote = F)
write.table(all_temp_sig.bed, "../analyses/DMR_output/bed/all_temp_sig.bed", sep = "\t",row.names = F, col.names = F, quote = F)
write.table(all.a_clust_sig.bed, "../analyses/DMR_output/bed/a_cluster.bed", sep = "\t",row.names = F, col.names = F, quote = F)
write.table(all.b_clust_sig.bed, "../analyses/DMR_output/bed/b_cluster.bed", sep = "\t",row.names = F, col.names = F, quote = F)
write.table(all.c_clust_sig.bed, "../analyses/DMR_output/bed/c_cluster.bed", sep = "\t",row.names = F, col.names = F, quote = F)
write.table(all.d_clust_sig.bed, "../analyses/DMR_output/bed/d_cluster.bed", sep = "\t",row.names = F, col.names = F, quote = F)
write.table(all.e_clust_sig.bed, "../analyses/DMR_output/bed/e_cluster.bed", sep = "\t",row.names = F, col.names = F, quote = F)

```

### Compare independent contrats
# Cc vs Dc (symbiont contribution)
#Keep only Control samples and allow only 1 NA 
```{r}
Ctrol_sample_DMR <- fread('../analyses/DMR_output/DMR_files/Control_SymbComp_DMR250bp_cov5x_rms_results_collapsed.tsv', sep = "\t", header = TRUE, stringsAsFactors = FALSE)
df <- data.frame() #create empty data frame to bind filtered rows into
for(i in (1:nrow(Ctrol_sample_DMR))){
  Cc <- Ctrol_sample_DMR[i,7:11] #define columns from the category CC
  Dc <- Ctrol_sample_DMR[i,12:17] #define columns from the category BC
     if(length(which(is.na(Cc))) < 2 & length(which(is.na(Dc))) < 2){
  df <- rbind(df,Ctrol_sample_DMR[i,]) #conditional statement: if less than 2 samples/category have NA for % methylation bind the whole row to the new dataframe
  }
}
#save df as a specific variable
Control_DMR <- df
Control_DMR <- Control_DMR[,c(1:17)]
```

# Run group statistics on regions to find regions that are significantly different among symbionts

Make a unique ID column 
```{r}
Control_DMR$ID <- paste(Control_DMR$`#chr`,":",Control_DMR$start,"-",Control_DMR$end, sep = "")
Control_DMR$ID <- gsub("__.*__.*:",":",Control_DMR$ID)
```

reformat data for calculating group effect
```{r}
#reformat all to long format
Control_DMR_STACKED <- tidyr::gather(Control_DMR[,7:ncol(Control_DMR)], "Sample.ID", "perc.meth",1:11)

#simplify sample ID column
Control_DMR_STACKED$Sample.ID <- gsub("methylation_level_","", Control_DMR_STACKED$Sample.ID)

#merge with meta data
Control_DMR_STACKED <- merge(Control_DMR_STACKED, meta_data, by = "Sample.ID")
#create a group variable for the combination of treatments
Control_DMR_STACKED <- Control_DMR_STACKED %>%
  mutate(sym = recode(trt1, b = "D", c = "C"),
         group = paste(sym, trt2, sep = ""))
Control_DMR_STACKED <- Control_DMR_STACKED[-7]

```

arc sin sqrt transform the data
```{r}
#arcsin sqrt transformation function
asinTransform <- function(p) { asin(sqrt(p))}

#arcsin transform data 
Control_DMR_STACKED_asin <- Control_DMR_STACKED
Control_DMR_STACKED_asin$perc.meth <- asinTransform(Control_DMR_STACKED_asin$perc.meth)
```

## One-way anova
**Hypotehsis: there is no effect of symbiont
```{r}
Control_DMR_1way_aov <- Control_DMR_STACKED_asin %>% group_by(ID) %>%
do(meth_aov_models = aov(perc.meth~group, data =  . ))
#summarize ANOVA data
Control_DMR_1way_aov_modelsumm  <- Control_DMR_1way_aov %>% ungroup %>% 
    pull(meth_aov_models) %>% 
    map_dfr(tidy, .id = 'grp')
#spread out pvalues
Control_DMR_1way_aov_modelsumm_wide <- data.frame(tidyr::pivot_wider(Control_DMR_1way_aov_modelsumm, names_from = term, values_from = c("df", "sumsq", "meansq","statistic","p.value"),names_sep = "_" ))
Control_DMR_1way_aov_modelsumm_wide <- cbind(Control_DMR_1way_aov[,1], Control_DMR_1way_aov_modelsumm_wide[,-c(1)])
Ctrol_aov_sig_DMR <- Control_DMR_1way_aov_modelsumm_wide[which(Control_DMR_1way_aov_modelsumm_wide$p.value_group <= 0.05), 1]

```
plot heatmap of Anova for sym p.val 0.05 sig DMRs
```{r}
#create matrix for Cc vs Dc
aov_0.05_Ctrols_DMR_m <- as.matrix(Control_DMR[,7:17])
rownames(aov_0.05_Ctrols_DMR_m) <- Control_DMR$ID
aov_0.05_Ctrols_DMR_m <- aov_0.05_Ctrols_DMR_m[which(rownames(aov_0.05_Ctrols_DMR_m) %in% pull(Control_DMR_1way_aov_modelsumm_wide[which(Control_DMR_1way_aov_modelsumm_wide$p.value_group<= 0.05),],ID)),]

#remove extra text from column names
colnames(aov_0.05_Ctrols_DMR_m) <- gsub("methylation_level_","",colnames(aov_0.05_Ctrols_DMR_m))

#plot for Control groups mean comparison

jpeg("../output/other/all.aov_0.05_DMR_CcDc_heatmap.jpg", width = 600, height = 1000)
HM <- heatmap.2(aov_0.05_Ctrols_DMR_m,margins = c(10,20), cexCol = 2, distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'),key.xtickfun = function() {
  breaks = pretty(parent.frame()$breaks)
  #breaks = breaks[c(1,length(breaks))]
  list(at = parent.frame()$scale01(breaks),labels = breaks)},Colv=NA, col= rev(colorRampPalette(brewer.pal(10, "RdYlBu"))(256)), density.info = "none", trace = "none", scale = "row", labRow = FALSE,sepwidth=c(0.01,0.01),sepcolor="white",colsep=1:ncol(aov_0.05_Ctrols_DMR_m),rowsep=1:nrow(aov_0.05_Ctrols_DMR_m),lmat = rbind(c(0,3),c(2,1),c(4,0)),keysize=0.5, key.par = list(cex=1),lhei=c(1.5,4,1), lwid = c(1.5,4))
dev.off()

upper_clust <- HM$rowInd[1:9]
lower_clust <- HM$rowInd[10:15]
Ctrol_upper_Clust <- Ctrol_aov_sig_DMR[upper_clust]
Ctrol_lower_Clust <- Ctrol_aov_sig_DMR[lower_clust]
```

# Ch vs Cc contrast(temp effect on Csymb)
# Keep only C-symb samples and allow only 1 NA 
```{r}
C_symb_sample_DMR <- fread('../analyses/DMR_output/DMR_files/Csymb_alltreat_DMR250bp_cov5x_rms_results_collapsed.tsv', sep = "\t", header = TRUE, stringsAsFactors = FALSE)

df <- data.frame() #create empty data frame to bind filtered rows into
for(i in (1:nrow(C_symb_sample_DMR))){
  Cc <- C_symb_sample_DMR[i,7:11] #define columns from the category CC
  Ch <- C_symb_sample_DMR[i,12:17] #define columns from the category CH (eliminate CH-26-2)
     if(length(which(is.na(Cc))) < 2 & length(which(is.na(Ch))) < 2){
  df <- rbind(df,C_symb_sample_DMR[i,]) #conditional statement: if less than 2 samples/category have NA for % methylation bind the whole row to the new dataframe
  }
}
#save df as a specific variable
C_symb_DMR <- df
C_symb_DMR <- C_symb_DMR[,c(1:17)]
```

Run group statistics on regions to find regions that are significantly different among treatments for C_symb

Make a unique ID column 
```{r}
C_symb_DMR$ID <- paste(C_symb_DMR$`#chr`,":",C_symb_DMR$start,"-",C_symb_DMR$end, sep = "")
C_symb_DMR$ID <- gsub("__.*__.*:",":",C_symb_DMR$ID)
```

reformat data for calculating group effect
```{r}
#reformat all to long format
C_symb_DMR_STACKED <- tidyr::gather(C_symb_DMR[,7:ncol(C_symb_DMR)], "Sample.ID", "perc.meth",1:11)

#simplify sample ID column
C_symb_DMR_STACKED$Sample.ID <- gsub("methylation_level_","", C_symb_DMR_STACKED$Sample.ID)

#merge with meta data
C_symb_DMR_STACKED <- merge(C_symb_DMR_STACKED, meta_data, by = "Sample.ID")
#create a group variable for the combination of treatments
C_symb_DMR_STACKED <- C_symb_DMR_STACKED %>%
  mutate(sym = recode(trt1, b = "D", c = "C"),
         group = paste(sym, trt2, sep = ""))
C_symb_DMR_STACKED <- C_symb_DMR_STACKED[-7]

```

arc sin sqrt transform the data
```{r}
#arcsin sqrt transformation function
asinTransform <- function(p) { asin(sqrt(p))}

#arcsin transform data 
C_symb_DMR_STACKED_asin <- C_symb_DMR_STACKED
C_symb_DMR_STACKED_asin$perc.meth <- asinTransform(C_symb_DMR_STACKED_asin$perc.meth)
```

## One-way anova
**Hypotehsis: there is no effect of temeparure on symbiont C
```{r}
C_symb_DMR_1way_aov <- C_symb_DMR_STACKED_asin %>% group_by(ID) %>%
do(meth_aov_models = aov(perc.meth~group, data =  . ))
#summarize ANOVA data
C_symb_DMR_1way_aov_modelsumm  <- C_symb_DMR_1way_aov %>% ungroup %>% 
    pull(meth_aov_models) %>% 
    map_dfr(tidy, .id = 'grp')
#spread out pvalues
C_symb_DMR_1way_aov_modelsumm_wide <- data.frame(tidyr::pivot_wider(C_symb_DMR_1way_aov_modelsumm, names_from = term, values_from = c("df", "sumsq", "meansq","statistic","p.value"),names_sep = "_" ))
C_symb_DMR_1way_aov_modelsumm_wide <- cbind(C_symb_DMR_1way_aov[,1], C_symb_DMR_1way_aov_modelsumm_wide[,-c(1)])
Csymb_aov_sig_DMR <- C_symb_DMR_1way_aov_modelsumm_wide[which(C_symb_DMR_1way_aov_modelsumm_wide$p.value_group <= 0.05), 1]

```

plot heatmap of Anova for C_symb p.val 0.05 sig DMRs
```{r}
#create matrix for Cc vs Dc
aov_0.05_C_symb_DMR_m <- as.matrix(C_symb_DMR[,7:17])
rownames(aov_0.05_C_symb_DMR_m) <- C_symb_DMR$ID
aov_0.05_C_symb_DMR_m <- aov_0.05_C_symb_DMR_m[which(rownames(aov_0.05_C_symb_DMR_m) %in% pull(C_symb_DMR_1way_aov_modelsumm_wide[which(C_symb_DMR_1way_aov_modelsumm_wide$p.value_group<= 0.05),],ID)),]

#remove extra text from column names
colnames(aov_0.05_C_symb_DMR_m) <- gsub("methylation_level_","",colnames(aov_0.05_C_symb_DMR_m))

#plot for Control groups mean comparison

jpeg("../output/other/all.aov_0.05_DMR_CcCh_mod__heatmap.jpg", width = 600, height = 1000)
HM <- heatmap.2(aov_0.05_C_symb_DMR_m,margins = c(10,20), cexCol = 2, distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'),key.xtickfun = function() {
  breaks = pretty(parent.frame()$breaks)
  #breaks = breaks[c(1,length(breaks))]
  list(at = parent.frame()$scale01(breaks),labels = breaks)},Colv=NA, col= rev(colorRampPalette(brewer.pal(10, "RdYlBu"))(256)), density.info = "none", trace = "none", scale = "row", labRow = FALSE,sepwidth=c(0.01,0.01),sepcolor="white",colsep=1:ncol(aov_0.05_C_symb_DMR_m),rowsep=1:nrow(aov_0.05_C_symb_DMR_m),lmat = rbind(c(0,3),c(2,1),c(4,0)),keysize=0.5, key.par = list(cex=1),lhei=c(1.5,4,1), lwid = c(1.5,4))
dev.off()


upper_clust <- HM$rowInd[1:43]
lower_clust <- HM$rowInd[44:73]
Csymb_upper_Clust <- Csymb_aov_sig_DMR[upper_clust]
Csymb_lower_Clust <- Csymb_aov_sig_DMR[lower_clust]
```

Dc vs Dh comparizon (temp effect on Dsymb)

```{r}
D_symb_samples_DMR <- fread('../analyses/DMR_output/DMR_files/Dsymb_alltreat_DMR250bp_cov5x_rms_results_collapsed.tsv', sep = "\t", header = TRUE, stringsAsFactors = FALSE)
df <- data.frame() #create empty data frame to bind filtered rows into
for(i in (1:nrow(D_symb_samples_DMR))){
  Dc <- D_symb_samples_DMR[i,7:12] #define columns from the category CC
  Dh <- D_symb_samples_DMR[i,13:18] #define columns from the category BC
     if(length(which(is.na(Dc))) < 2 & length(which(is.na(Dh))) < 2){
  df <- rbind(df,D_symb_samples_DMR[i,]) #conditional statement: if less than 2 samples/category have NA for % methylation bind the whole row to the new dataframe
  }
}
#save df as a specific variable
D_symb_DMR <- df
D_symb_DMR <- D_symb_DMR[,c(1:18)]
```

Run group statistics on regions to find regions that are significantly different among treatments for symb_D

Make a unique ID column 
```{r}
D_symb_DMR$ID <- paste(D_symb_DMR$`#chr`,":",D_symb_DMR$start,"-",D_symb_DMR$end, sep = "")
D_symb_DMR$ID <- gsub("__.*__.*:",":",D_symb_DMR$ID)
```

reformat data for calculating group effect
```{r}
#reformat all to long format
D_symb_DMR_STACKED <- tidyr::gather(D_symb_DMR[,7:ncol(D_symb_DMR)], "Sample.ID", "perc.meth",1:12)

#simplify sample ID column
D_symb_DMR_STACKED$Sample.ID <- gsub("methylation_level_","", D_symb_DMR_STACKED$Sample.ID)

#merge with meta data
D_symb_DMR_STACKED <- merge(D_symb_DMR_STACKED, meta_data, by = "Sample.ID")
#create a group variable for the combination of treatments
D_symb_DMR_STACKED <- D_symb_DMR_STACKED %>%
  mutate(sym = recode(trt1, b = "D", c = "C"),
         group = paste(sym, trt2, sep = ""))
D_symb_DMR_STACKED <- D_symb_DMR_STACKED[-7]

```

arc sin sqrt transform the data
```{r}
#arcsin sqrt transformation function
asinTransform <- function(p) { asin(sqrt(p))}

#arcsin transform data 
D_symb_DMR_STACKED_asin <- D_symb_DMR_STACKED
D_symb_DMR_STACKED_asin$perc.meth <- asinTransform(D_symb_DMR_STACKED_asin$perc.meth)
```

## One-way anova
**Hypotehsis: there is no effect of temperature
```{r}
D_symb_DMR_1way_aov <- D_symb_DMR_STACKED_asin %>% group_by(ID) %>%
do(meth_aov_models = aov(perc.meth~group, data =  . ))
#summarize ANOVA data
D_symb_DMR_1way_aov_modelsumm  <- D_symb_DMR_1way_aov %>% ungroup %>% 
    pull(meth_aov_models) %>% 
    map_dfr(tidy, .id = 'grp')
#spread out pvalues
D_symb_DMR_1way_aov_modelsumm_wide <- data.frame(tidyr::pivot_wider(D_symb_DMR_1way_aov_modelsumm, names_from = term, values_from = c("df", "sumsq", "meansq","statistic","p.value"),names_sep = "_" ))
D_symb_DMR_1way_aov_modelsumm_wide <- cbind(D_symb_DMR_1way_aov[,1], D_symb_DMR_1way_aov_modelsumm_wide[,-c(1)])
Dsymb_aov_sig_DMR <-D_symb_DMR_1way_aov_modelsumm_wide[which(D_symb_DMR_1way_aov_modelsumm_wide$p.value_group <= 0.05), 1]

```
plot heatmap of Anova for sym-D p.val 0.05 sig DMRs
```{r}
#create matrix for Cc vs Dc
aov_0.05_D_symb_DMR_m <- as.matrix(D_symb_DMR[,7:18])
rownames(aov_0.05_D_symb_DMR_m) <- D_symb_DMR$ID
aov_0.05_D_symb_DMR_m <- aov_0.05_D_symb_DMR_m[which(rownames(aov_0.05_D_symb_DMR_m) %in% pull(D_symb_DMR_1way_aov_modelsumm_wide[which(D_symb_DMR_1way_aov_modelsumm_wide$p.value_group<= 0.05),],ID)),]

#remove extra text from column names
colnames(aov_0.05_D_symb_DMR_m) <- gsub("methylation_level_","",colnames(aov_0.05_D_symb_DMR_m))

#plot for Control groups mean comparison

jpeg("../output/other/all.aov_0.05_DMR_DcDh_heatmap.jpg", width = 600, height = 1000)
HM <- heatmap.2(aov_0.05_D_symb_DMR_m,margins = c(10,20), cexCol = 2, distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'),key.xtickfun = function() {
  breaks = pretty(parent.frame()$breaks)
  #breaks = breaks[c(1,length(breaks))]
  list(at = parent.frame()$scale01(breaks),labels = breaks)},Colv=NA, col= rev(colorRampPalette(brewer.pal(10, "RdYlBu"))(256)), density.info = "none", trace = "none", scale = "row", labRow = FALSE,sepwidth=c(0.01,0.01),sepcolor="white",colsep=1:ncol(aov_0.05_D_symb_DMR_m),rowsep=1:nrow(aov_0.05_D_symb_DMR_m),lmat = rbind(c(0,3),c(2,1),c(4,0)),keysize=0.5, key.par = list(cex=1),lhei=c(1.5,4,1), lwid = c(1.5,4))
dev.off()

upper_clust <- HM$rowInd[1:18]
lower_clust <- HM$rowInd[19:26]
Dsymb_upper_Clust <- Dsymb_aov_sig_DMR[upper_clust]
Dsymb_lower_Clust <- Dsymb_aov_sig_DMR[lower_clust]

```

# Part 4: Ch vs Dh comparizon (differential temp effect by symbiont)

Keep only Heated samples and allow only 1 NA 
```{r}
Heated_sample_DMR <- fread('../analyses/DMR_output/DMR_files/Heated_Symb_DMR250bp_cov5x_rms_results_collapsed.tsv', sep = "\t", header = TRUE, stringsAsFactors = FALSE)
df <- data.frame() #create empty data frame to bind filtered rows into
for(i in (1:nrow(allsamples_DMR))){
  Ch <- Heated_sample_DMR[i,7:12] #define columns from the category CC
  Dh <- Heated_sample_DMR[i,13:18] #define columns from the category BC
     if(length(which(is.na(Ch))) < 2 & length(which(is.na(Dh))) < 2){
  df <- rbind(df,Heated_sample_DMR[i,]) #conditional statement: if less than 2 samples/category have NA for % methylation bind the whole row to the new dataframe
  }
}
#save df as a specific variable
Heated_DMR <- df
Heated_DMR <- Heated_DMR[,c(1:18)]
```


# Run group statistics on regions to find regions that are significantly different among symbionts
Make a unique ID column 
```{r}
Heated_DMR$ID <- paste(Heated_DMR$`#chr`,":",Heated_DMR$start,"-",Heated_DMR$end, sep = "")
Heated_DMR$ID <- gsub("__.*__.*:",":",Heated_DMR$ID)
```

reformat data for calculating group effect
```{r}
#reformat all to long format
Heated_DMR_STACKED <- tidyr::gather(Heated_DMR[,7:ncol(Heated_DMR)], "Sample.ID", "perc.meth",1:12)

#simplify sample ID column
Heated_DMR_STACKED$Sample.ID <- gsub("methylation_level_","", Heated_DMR_STACKED$Sample.ID)

#merge with meta data
Heated_DMR_STACKED <- merge(Heated_DMR_STACKED, meta_data, by = "Sample.ID")
#create a group variable for the combination of treatments
Heated_DMR_STACKED <- Heated_DMR_STACKED %>%
  mutate(sym = recode(trt1, b = "D", c = "C"),
         group = paste(sym, trt2, sep = ""))
Heated_DMR_STACKED <- Heated_DMR_STACKED[-7]

```

arc sin sqrt transform the data
```{r}
#arcsin sqrt transformation function
asinTransform <- function(p) { asin(sqrt(p))}

#arcsin transform data 
Heated_DMR_STACKED_asin <- Heated_DMR_STACKED
Heated_DMR_STACKED_asin$perc.meth <- asinTransform(Heated_DMR_STACKED_asin$perc.meth)
```

## One-way anova
**Hypotehsis: there is no effect of symbiont
```{r}
Heated_DMR_1way_aov <- Heated_DMR_STACKED_asin %>% group_by(ID) %>%
do(meth_aov_models = aov(perc.meth~group, data =  . ))
#summarize ANOVA data
Heated_DMR_1way_aov_modelsumm  <- Heated_DMR_1way_aov %>% ungroup %>% 
    pull(meth_aov_models) %>% 
    map_dfr(tidy, .id = 'grp')
#spread out pvalues
Heated_DMR_1way_aov_modelsumm_wide <- data.frame(tidyr::pivot_wider(Heated_DMR_1way_aov_modelsumm, names_from = term, values_from = c("df", "sumsq", "meansq","statistic","p.value"),names_sep = "_" ))
Heated_DMR_1way_aov_modelsumm_wide <- cbind(Heated_DMR_1way_aov[,1], Heated_DMR_1way_aov_modelsumm_wide[,-c(1)])
Heated_aov_sig_DMR <- Heated_DMR_1way_aov_modelsumm_wide[which(Heated_DMR_1way_aov_modelsumm_wide$p.value_group <= 0.05), 1]

```

plot heatmap of Anova for Heat treatment p.val 0.05 sig DMRs
```{r}
#create matrix for Ch vs Dh
aov_0.05_Heated_DMR_m <- as.matrix(Heated_DMR[,7:18])
rownames(aov_0.05_Heated_DMR_m) <- Heated_DMR$ID
aov_0.05_Heated_DMR_m <- aov_0.05_Heated_DMR_m[which(rownames(aov_0.05_Heated_DMR_m) %in% pull(Heated_DMR_1way_aov_modelsumm_wide[which(Heated_DMR_1way_aov_modelsumm_wide$p.value_group<= 0.05),],ID)),]

#remove extra text from column names
colnames(aov_0.05_Heated_DMR_m) <- gsub("methylation_level_","",colnames(aov_0.05_Heated_DMR_m))

#plot for Control groups mean comparison

jpeg("../output/other/all.aov_0.05_ChDh__heatmap.jpg", width = 600, height = 1000)
heatmap.2(aov_0.05_Heated_DMR_m,margins = c(10,20), cexCol = 2, distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'),key.xtickfun = function() {
  breaks = pretty(parent.frame()$breaks)
  #breaks = breaks[c(1,length(breaks))]
  list(at = parent.frame()$scale01(breaks),labels = breaks)},Colv=NA, col= rev(colorRampPalette(brewer.pal(10, "RdYlBu"))(256)), density.info = "none", trace = "none", scale = "row", labRow = FALSE,sepwidth=c(0.01,0.01),sepcolor="white",colsep=1:ncol(aov_0.05_Heated_DMR_m),rowsep=1:nrow(aov_0.05_Heated_DMR_m),lmat = rbind(c(0,3),c(2,1),c(4,0)),keysize=0.5, key.par = list(cex=1),lhei=c(1.5,4,1), lwid = c(1.5,4))
dev.off()

upper_clust <- HM$rowInd[1:73]
lower_clust <- HM$rowInd[74:132]
Heated_upper_Clust <- Heated_aov_sig_DMR[upper_clust]
Heated_lower_Clust <- Heated_aov_sig_DMR[lower_clust]
```
# DMR overlap between contrasts 

```{r}
venn.diagram(
        x = list(Ctrol_aov_sig_DMR, Csymb_aov_sig_DMR, Dsymb_aov_sig_DMR, Heated_aov_sig_DMR),
        category.names = c("Dc.vs.Cc", "Ch.vs.Cc ", "Dh.vs.Dc", "Dh.vs.Ch"),
        filename = '../output/other/DMR_Contrasts_venn_diagramm.png',
        output=TRUE)
       
```


# Create bed files for individual contrasts 
```{r}
# Individual contrasts DMRs
Control_DMR_1way_aov_modelsumm_wide$scaffold <- gsub("\\:.*","", Control_DMR_1way_aov_modelsumm_wide$ID)
Control_DMR_1way_aov_modelsumm_wide$start <- gsub(".*\\:","", Control_DMR_1way_aov_modelsumm_wide$ID)
Control_DMR_1way_aov_modelsumm_wide$start <- gsub("-.*","", Control_DMR_1way_aov_modelsumm_wide$start)
Control_DMR_1way_aov_modelsumm_wide$end <- gsub(".*-","",  Control_DMR_1way_aov_modelsumm_wide$ID)
Control_DMR_sig.bed <- Control_DMR_1way_aov_modelsumm_wide[which(Control_DMR_1way_aov_modelsumm_wide$p.value_group < 0.05), c("scaffold","start", "end")]

Heated_DMR_1way_aov_modelsumm_wide$scaffold <- gsub("\\:.*","", Heated_DMR_1way_aov_modelsumm_wide$ID)
Heated_DMR_1way_aov_modelsumm_wide$start <- gsub(".*\\:","", Heated_DMR_1way_aov_modelsumm_wide$ID)
Heated_DMR_1way_aov_modelsumm_wide$start <- gsub("-.*","", Heated_DMR_1way_aov_modelsumm_wide$start)
Heated_DMR_1way_aov_modelsumm_wide$end <- gsub(".*-","",  Heated_DMR_1way_aov_modelsumm_wide$ID)
Heated_DMR_sig.bed <- Heated_DMR_1way_aov_modelsumm_wide[which(Heated_DMR_1way_aov_modelsumm_wide$p.value_group < 0.05), c("scaffold","start", "end")]

C_symb_DMR_1way_aov_modelsumm_wide$scaffold <- gsub("\\:.*","", C_symb_DMR_1way_aov_modelsumm_wide$ID)
C_symb_DMR_1way_aov_modelsumm_wide$start <- gsub(".*\\:","", C_symb_DMR_1way_aov_modelsumm_wide$ID)
C_symb_DMR_1way_aov_modelsumm_wide$start <- gsub("-.*","", C_symb_DMR_1way_aov_modelsumm_wide$start)
C_symb_DMR_1way_aov_modelsumm_wide$end <- gsub(".*-","",  C_symb_DMR_1way_aov_modelsumm_wide$ID)
C_symb_DMR_sig.bed <- C_symb_DMR_1way_aov_modelsumm_wide[which(C_symb_DMR_1way_aov_modelsumm_wide$p.value_group < 0.05), c("scaffold","start", "end")]

D_symb_DMR_1way_aov_modelsumm_wide$scaffold <- gsub("\\:.*","", D_symb_DMR_1way_aov_modelsumm_wide$ID)
D_symb_DMR_1way_aov_modelsumm_wide$start <- gsub(".*\\:","", D_symb_DMR_1way_aov_modelsumm_wide$ID)
D_symb_DMR_1way_aov_modelsumm_wide$start <- gsub("-.*","", D_symb_DMR_1way_aov_modelsumm_wide$start)
D_symb_DMR_1way_aov_modelsumm_wide$end <- gsub(".*-","",  D_symb_DMR_1way_aov_modelsumm_wide$ID)
D_symb_DMR_sig.bed <- D_symb_DMR_1way_aov_modelsumm_wide[which(D_symb_DMR_1way_aov_modelsumm_wide$p.value_group < 0.05), c("scaffold","start", "end")]

#add column denoting tested effect
Control_DMR_sig.bed$test <- "Cc.vs.Dc"
Heated_DMR_sig.bed$test <- "Ch.vs.Dh"
C_symb_DMR_sig.bed$test <- "Cc.vs.Ch"
D_symb_DMR_sig.bed$test <- "Dc.vs.Dh"

#write out data
write.table(Control_DMR_sig.bed, "../analyses/DMR_output/bed/aov_0.05_Cc_Dc.bed", sep = "\t",row.names = F, col.names = F, quote = F)
write.table(Heated_DMR_sig.bed, "../analyses/DMR_output/bed/aov_0.05_Ch_Dh.bed", sep = "\t",row.names = F, col.names = F, quote = F)
write.table(C_symb_DMR_sig.bed, "../analyses/DMR_output/bed/aov_0.05_Cc_Ch.bed", sep = "\t",row.names = F, col.names = F, quote = F)
write.table(D_symb_DMR_sig.bed, "../analyses/DMR_output/bed/aov_0.05_Dc_Dh.bed", sep = "\t",row.names = F, col.names = F, quote = F)

```


